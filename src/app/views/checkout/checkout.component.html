<div class="checkout-container py-5">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="checkout-header mb-4">
          <h2 class="checkout-title">
            <span *ngIf="!route.snapshot.queryParams['retry']">Thanh toán</span>
            <span *ngIf="route.snapshot.queryParams['retry']">Thanh toán lại</span>
          </h2>
          <p class="checkout-subtitle text-muted">
            <span *ngIf="!route.snapshot.queryParams['retry']">Hoàn tất thông tin để đặt hàng</span>
            <span *ngIf="route.snapshot.queryParams['retry']">Thử lại thanh toán cho đơn hàng #{{ route.snapshot.queryParams['orderId'] }}</span>
          </p>
          <div *ngIf="route.snapshot.queryParams['retry']" class="alert alert-info">
            <i class="cil-info me-2"></i>
            <strong>Lưu ý:</strong> Đây là đơn hàng mới được tạo từ đơn hàng cũ. Thông tin đã được điền sẵn, bạn có thể chỉnh sửa nếu cần.
          </div>
        </div>
      </div>
    </div>

    <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()">
      <div class="row">
        <!-- Form thông tin khách hàng -->
        <div class="col-lg-8">
          <div class="checkout-form-card">
            <!-- Thông tin giao hàng -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="cil-location-pin me-2"></i>
                Thông tin giao hàng
              </h5>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="fullName" class="form-label">Họ và tên *</label>
                  <input type="text"
                         class="form-control"
                         id="fullname"
                         formControlName="fullname"
                         [class.is-invalid]="isFieldInvalid('fullname')"
                         placeholder="Nhập họ và tên">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('fullname')">
                    {{ getFieldError('fullname') }}
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="email" class="form-label">Email *</label>
                  <input type="email"
                         class="form-control"
                         id="email"
                         formControlName="email"
                         [class.is-invalid]="isFieldInvalid('email')"
                         placeholder="Nhập email">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('email')">
                    {{ getFieldError('email') }}
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="phone" class="form-label">Số điện thoại *</label>
                  <input type="tel"
                         class="form-control"
                         id="phone"
                         formControlName="phone"
                         [class.is-invalid]="isFieldInvalid('phone')"
                         placeholder="Nhập số điện thoại">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('phone')">
                    {{ getFieldError('phone') }}
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="city" class="form-label">Tỉnh/Thành phố *</label>
                  <select class="form-select"
                          id="city"
                          formControlName="city"
                          [class.is-invalid]="isFieldInvalid('city')">
                    <option value="">Chọn tỉnh/thành phố</option>
                    <option value="hanoi">Hà Nội</option>
                    <option value="hcm">TP. Hồ Chí Minh</option>
                    <option value="danang">Đà Nẵng</option>
                    <option value="haiphong">Hải Phòng</option>
                    <option value="cantho">Cần Thơ</option>
                    <option value="angiang">An Giang</option>
                    <option value="bacgiang">Bắc Giang</option>
                    <option value="backan">Bắc Kạn</option>
                    <option value="baclieu">Bạc Liêu</option>
                    <option value="bacninh">Bắc Ninh</option>
                    <option value="bariavungtau">Bà Rịa - Vũng Tàu</option>
                    <option value="bentre">Bến Tre</option>
                    <option value="binhdinh">Bình Định</option>
                    <option value="binhduong">Bình Dương</option>
                    <option value="binhphuoc">Bình Phước</option>
                    <option value="binhthuan">Bình Thuận</option>
                    <option value="camau">Cà Mau</option>
                    <option value="caobang">Cao Bằng</option>
                    <option value="daklak">Đắk Lắk</option>
                    <option value="daknong">Đắk Nông</option>
                    <option value="dienbien">Điện Biên</option>
                    <option value="dongnai">Đồng Nai</option>
                    <option value="dongthap">Đồng Tháp</option>
                    <option value="gialai">Gia Lai</option>
                    <option value="hagiang">Hà Giang</option>
                    <option value="hanam">Hà Nam</option>
                    <option value="hatinh">Hà Tĩnh</option>
                    <option value="haiduong">Hải Dương</option>
                    <option value="hau giang">Hậu Giang</option>
                    <option value="hoabinh">Hòa Bình</option>
                    <option value="hungyen">Hưng Yên</option>
                    <option value="khanhhoa">Khánh Hòa</option>
                    <option value="kiengiang">Kiên Giang</option>
                    <option value="kontum">Kon Tum</option>
                    <option value="laichau">Lai Châu</option>
                    <option value="lamdong">Lâm Đồng</option>
                    <option value="langson">Lạng Sơn</option>
                    <option value="laocai">Lào Cai</option>
                    <option value="longan">Long An</option>
                    <option value="namdinh">Nam Định</option>
                    <option value="nghean">Nghệ An</option>
                    <option value="ninhbinh">Ninh Bình</option>
                    <option value="ninhthuan">Ninh Thuận</option>
                    <option value="phutho">Phú Thọ</option>
                    <option value="phuyen">Phú Yên</option>
                    <option value="quangbinh">Quảng Bình</option>
                    <option value="quangnam">Quảng Nam</option>
                    <option value="quangngai">Quảng Ngãi</option>
                    <option value="quangninh">Quảng Ninh</option>
                    <option value="quangtri">Quảng Trị</option>
                    <option value="soctrang">Sóc Trăng</option>
                    <option value="sonla">Sơn La</option>
                    <option value="tayninh">Tây Ninh</option>
                    <option value="thaibinh">Thái Bình</option>
                    <option value="thainguyen">Thái Nguyên</option>
                    <option value="thanhhoa">Thanh Hóa</option>
                    <option value="thuathienhue">Thừa Thiên Huế</option>
                    <option value="tiengiang">Tiền Giang</option>
                    <option value="travinh">Trà Vinh</option>
                    <option value="tuyenquang">Tuyên Quang</option>
                    <option value="vinhlong">Vĩnh Long</option>
                    <option value="vinhphuc">Vĩnh Phúc</option>
                    <option value="yenbai">Yên Bái</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('city')">
                    {{ getFieldError('city') }}
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="district" class="form-label">Quận/Huyện *</label>
                  <select class="form-select"
                          id="district"
                          formControlName="district"
                          [class.is-invalid]="isFieldInvalid('district')"
                          [disabled]="!checkoutForm.get('city')?.value">
                    <option value="">Chọn quận/huyện</option>
                    <option *ngFor="let district of availableDistricts"
                            [value]="district.value">
                      {{ district.label }}
                    </option>
                  </select>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('district')">
                    {{ getFieldError('district') }}
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="address" class="form-label">Địa chỉ chi tiết *</label>
                <textarea class="form-control"
                          id="address"
                          formControlName="address"
                          [class.is-invalid]="isFieldInvalid('address')"
                          rows="3"
                          placeholder="Nhập địa chỉ chi tiết (số nhà, đường, phường/xã)"></textarea>
                <div class="invalid-feedback" *ngIf="isFieldInvalid('address')">
                  {{ getFieldError('address') }}
                </div>
              </div>

              <div class="mb-3">
                <label for="note" class="form-label">Ghi chú</label>
                <textarea class="form-control"
                          id="note"
                          formControlName="note"
                          rows="2"
                          placeholder="Ghi chú thêm về đơn hàng (không bắt buộc)"></textarea>
              </div>
            </div>

            <!-- Phương thức thanh toán -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="cil-credit-card me-2"></i>
                Phương thức thanh toán
              </h5>

                                                        <div class="payment-methods">
                <div class="form-check mb-3" *ngFor="let method of paymentMethods">
                  <input class="form-check-input"
                         type="radio"
                         [id]="'payment-' + method.value"
                         formControlName="paymentMethod"
                         [value]="method.value">
                  <label class="form-check-label" [for]="'payment-' + method.value">
                    <i [class]="method.icon + ' me-2'"></i>
                    {{ method.label }}
                  </label>
                </div>

                <!-- Debug buttons -->
                <div class="mt-3 p-3 bg-light border rounded">
                  <small class="text-muted">Debug - Test payment methods:</small>
                  <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" (click)="testPaymentMethodSelection('cod')">Test COD</button>
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" (click)="testPaymentMethodSelection('bank')">Test Bank</button>
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" (click)="testPaymentMethodSelection('vnpay')">Test VNPay</button>
                  </div>
                  <small class="text-muted mt-2 d-block">Current selection: {{ checkoutForm.get('paymentMethod')?.value }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tóm tắt đơn hàng -->
        <div class="col-lg-4">
          <div class="order-summary-card">
            <div class="summary-header">
              <h5>Tóm tắt đơn hàng</h5>
            </div>

            <div class="summary-body">
              <!-- Danh sách sản phẩm -->
              <div class="order-items">
                <div class="order-item" *ngFor="let item of selectedItems">
                  <div class="item-info">
                    <div class="item-image">
                      <img [src]="item.image" [alt]="item.name">
                    </div>
                    <div class="item-details">
                      <h6 class="item-name">{{ item.name }}</h6>
                      <p class="item-quantity">Số lượng: {{ item.quantity }}</p>
                    </div>
                  </div>
                  <div class="item-price">
                    {{ item.price * item.quantity | currency:'VND' }}
                  </div>
                </div>
              </div>

              <!-- Tổng tiền -->
              <div class="summary-totals">
                <div class="summary-item">
                  <span class="label">Tạm tính</span>
                  <span class="value">{{ totalAmount | currency:'VND' }}</span>
                </div>
                <div class="summary-item">
                  <span class="label">Phí vận chuyển</span>
                  <span class="value free">Miễn phí</span>
                </div>
                <div class="summary-divider"></div>
                <div class="summary-total">
                  <span class="label">Tổng cộng</span>
                  <span class="value total">{{ getTotalWithShipping() | currency:'VND' }}</span>
                </div>
              </div>
            </div>

            <div class="summary-footer">
              <button type="submit"
                      class="btn btn-checkout w-100"
                      [disabled]="loading || checkoutForm.invalid">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                <i *ngIf="!loading" class="cil-credit-card me-2"></i>
                {{ loading ? 'Đang xử lý...' : (route.snapshot.queryParams['retry'] ? 'Thanh toán lại' : 'Đặt hàng') }}
              </button>
              <button type="button"
                      class="btn btn-back w-100"
                      (click)="goBackToCart()">
                <i class="cil-arrow-left me-2"></i>
                Quay lại giỏ hàng
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
